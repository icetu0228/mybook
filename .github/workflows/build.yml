name: Build my gitbook and deploy to gh-pages

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    environment: github-pages # 建議使用 Pages 環境

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    # --- GitBook 環境設置 ---
    # GitBook 官方已停止維護，且與新版 Node 不相容。Node 16 是一個相對穩定的選擇。
    - name: Install Node 16 (GitBook requires old Node)
      uses: actions/setup-node@v3
      with:
        node-version: "16"

    - name: Install GitBook CLI
      # GitBook CLI 會自動下載並安裝 book_sources/ 目錄所需的 GitBook 引擎版本
      run: |
        npm install -g gitbook-cli

    - name: Install GitBook plugins
      run: |
        # 執行 gitbook install 會在 book_sources/ 內建立 node_modules/ 目錄
        cd book_sources
        gitbook install

    - name: Build GitBook
      run: |
        cd book_sources
        # 建構完成的靜態檔案輸出到專案根目錄的 _book/
        gitbook build ./ ../_book

    #  空間不足解決方案：在部署前清理大型檔案 
    - name:  清理建構暫存檔案 (釋放空間)
      # 刪除 node_modules 和 npm/yarn 快取，這些在建構完成後不再需要
      run: |
        echo "清理建構過程產生的 node_modules/ (佔用空間大)..."
        # 刪除書籍源碼目錄中的 node_modules (內含插件)
        sudo rm -rf ./book_sources/node_modules
        
        echo "清理 npm 快取..."
        # 清理 npm 全域快取
        npm cache clean --force
        
        echo "清理後的磁碟使用情況："
        df -h
    #  確保部署有足夠空間 

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./_book
        commit_message: "Deploy GitBook via GitHub Actions"